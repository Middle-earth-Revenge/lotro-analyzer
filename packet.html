<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<style type="text/css">
			body {
				font-family: sans-serif;
			}
			div#packet_offset, div#packet_hex, div#packet_decoded {
				font-family: monospace;
				float: left;
				line-height: 150%;
			}
			div#legend {
				clear: both;
				margin-top: 5px;
			}
			div#packet_decoded, div#packet_hex {
				margin-left: 8px;
			}
		</style>
	</head>
	<body>
		<script type="text/javascript">
			var data = '000000000061000100000000000039F7C460000000003F3036313030345F6E65747665723A373533373B206469647665723A39323643443845332D323938342D344341392D394336422D3644463243384542364243331D000000010000000000000034B5FE5008740065007300740075007300650072';

			var metadata = [
				{
					name: 'header',
					start: 0x00,
					end: 0x15,
					description: '<b>Payload Header part</b>',
					color: '#000000',
					foregroundColor: '#ffffff'
				},
				{
					name: 'header0',
					start: 0x02,
					end: 0x03,
					description: 'The (pseudo) Header part â€“ During session setup (the header starts with 0x00 0x00) its length is 22 bytes, in all other cases its 20 bytes long',
					color: '#c2d59b'
				},
				{
					name: 'header1',
					start: 0x04,
					end: 0x05,
					description: 'Session ID from client / server',
					color: '#ff66cc'
				},
				{
					name: 'header2',
					start: 0x06,
					end: 0x09,
					description: 'Size of Payload Data part (0x0061h == 97 bytes payload data part length)',
					color: '#66ff33'
				},
				{
					name: 'header3',
					start: 0x0A,
					end: 0x0D,
					description: 'Packet sequence number (no sequence during session establishment)',
					color: '#ffc000'
				},
				{
					name: 'header4',
					start: 0x0E,
					end: 0x11,
					description: 'Checksum for Payload Data part',
					color: '#ff0000'
				},
				{
					name: 'header5',
					start: 0x12,
					end: 0x15,
					description: 'Temporary session number (???)',
					color: '#8db3e1'
				},
				{
					name: 'data',
					start: 0x16,
					end: 0x75,
					description: '<b>Payload Data part</b>',
					color: '#aaaaaa',
				},
				{
					name: 'data0',
					start: 0x16,
					end: 0x55,
					description: 'Client-Version string with leading length',
					color: '#c2d59b'
				},
				{
					name: 'data1',
					start: 0x56,
					end: 0x59,
					description: 'Length of remaining data inside the packet',
					color: '#ffc000'
				},
				{
					name: 'data2',
					start: 0x5A,
					end: 0x61,
					description: 'Unknown',
					color: '#ffff00'
				},
				{
					name: 'data3',
					start: 0x62,
					end: 0x65,
					description: 'Date & Time when packet was generated [since 01.01.1970]',
					color: '#00afef'
				},
				{
					name: 'data4',
					start: 0x66,
					end: 0x75,
					description: 'Unicode Account name with leading length', 
					color: '#ff66cc'
				}
			];

			function padLeadingZeros(number) {
				var tmp = '' + number;
				while (tmp.length < 8) {
					tmp = '0' + tmp;
				}
				return tmp;
			}

			function renderPacket() {
				var generatedCss = '<style type="text/css">';
				$(metadata).each(function(index, element) {
					if (element.color) {
						var foregroundColor;
						if (element.foregroundColor) {
							foregroundColor = element.foregroundColor;
						} else {
							foregroundColor = '#000000';
						}
						generatedCss += '.' + element.name + ' { margin-left: -1px; margin-right: -1px; border: 1px solid ' + element.color + '; color: ' + element.color + '; }\n' + 
							'.' + element.name + '_hovered { background-color: ' + element.color + '; color: ' + foregroundColor + '; }\n';
					}
				});

				$(generatedCss + '</style>').appendTo('head');

				var packet_offset, offset, packet_hex, packet_decoded, legend;
				offset = 0;
				packet_offset = 'Offset(h)<br/>' + padLeadingZeros(offset);
				packet_hex = '00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F<br/>';
				packet_decoded = '<br/>';
				legend = '';
				for (var i = 0; i < data.length; i+=2) {
					$(metadata).each(function(index, element) {
						if (element.start*2 == i) {
							packet_hex += '<span class="hoverable ' + element.name + '">';
							packet_decoded += '<span class="hoverable ' + element.name + '">';
							legend += '<div class="hoverable ' + element.name + '">' + element.description;
						}
					});

					packet_hex += data.substr(i, 2);
					var tmp = parseInt(data.substr(i, 2), 16);
					if (tmp < 33 || (tmp > 126 && tmp < 161)) {
						tmp = '.';
					} else {
						tmp = String.fromCharCode(tmp);
					}
					packet_decoded += tmp;

					$(metadata).each(function(index, element) {
						if (element.end*2 == i) {
							packet_hex += '</span>';
							packet_decoded += '</span>';
							legend += '</div>';
						}
					});

					packet_hex += ' ';
					
					// Add line breaks where necessary
					if (i % 32 == 30) {
						offset += 10;
						packet_offset += '<br/>' + padLeadingZeros(offset);
						packet_hex += '<br/>';
						packet_decoded += '<br/>';
					}

				}

				$('#packet_offset').html(packet_offset);
				$('#packet_hex').html(packet_hex);
				$('#packet_decoded').html(packet_decoded);
				$('#legend').html(legend);

				$('.hoverable').each(function(index, element) {
					$(element).on('mouseover', function(event) {
						$($(this).attr('class').split(' ')).each(function(index1, element1) {
							if (element1.indexOf('hover') == -1) {
								$('.' + element1).each(function (index2, element2) {
									$(element2).addClass(element1 + '_hovered');
								});
							}
						});
						event.stopPropagation();
					});
					$(element).on('mouseout', function(event) {
						$($(this).attr('class').split(' ')).each(function(index1, element1) {
							if (element1.indexOf('hover') == -1) {
								$('.' + element1).each(function (index2, element2) {
									$(element2).removeClass(element1 + '_hovered');
								});
							}
						});
						event.stopPropagation();
					});
				});
			}

			$(function() {
				renderPacket(data);
			});
		</script>
		<div id="packet_offset"></div>
		<div id="packet_hex"></div>
		<div id="packet_decoded"></div>
		<div id="legend"></div>
	</body>
</html>
